---
title: "R Notebook"
output: html_notebook
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```


```{r}
library(tidyverse)
library(dplyr)
library(readxl)
library(naniar)
library(imputeTS)
library(zoo)
```

### Life Expectancy
```{r}
# Transforming and cleaning - Life Expectancy data

le<-read.csv("../Resources/Raw/Life_expectancy.csv",check.names=TRUE,header = TRUE, sep = ",", stringsAsFactors = FALSE, skip = 4)

# Remove unwanted fields
le<-select(le,-c(Indicator.Name,Indicator.Code,X))

# Transform
le<-gather(le,key="Year",value="LE",X1960:X2020)

# Streamline
le$Year<-gsub("X","",le$Year)%>%as.numeric(as.character(le$Year))

# Checking for missing values
le<-subset(le,Year<=2019&Year>=2000) 
le%>%group_by(Country.Name)%>%miss_var_summary()%>%filter(n_miss>0)

# Handling missing values
le<-le%>%group_by(Country.Name)%>%filter(!mean(is.na(LE)) >= 0.2)
le%>%group_by(Country.Name)%>%miss_var_summary()%>%filter(n_miss>0)

# Filling in missing values
le<-le%>%group_by(Country.Name)%>%mutate(LE = imputeTS::na_interpolation(LE))

# Final cleanup
le%>%group_by(Country.Name)%>%miss_var_summary()%>%filter(n_miss>0)
names(le)<-c("Country","Code","Year","LE_Code")

```

### Habits
```{r}
# Transforming and cleaning - Alcohol - Habits
Alcohol_consumption<-read_excel("../Resources/Raw/Alcohol_consumption.xlsx",skip=2)

# Remove unwanted fields
Alcohol_consumption<-subset(Alcohol_consumption,Dim1=="All types")
Alcohol_consumption<-select(Alcohol_consumption,c(SpatialDimValueCode,Location,Period,FactValueNumeric))

# Converting year to proper format
Alcohol_consumption$Period<-as.numeric(as.character(Alcohol_consumption$Period))

# Checking for missing values
Alcohol_consumption%>%filter(Period>=2000)%>%group_by(Location)%>%miss_var_summary()%>%filter(n_miss>0)
Alcohol_consumption%>%group_by(Period)%>%count()
# Extending years for countries missing the year
Alcohol_consumption<-Alcohol_consumption%>%complete(Period=seq(min(Period),max(Period)),Location)%>%group_by(Location)%>%fill(SpatialDimValueCode,.direction ="downup")
Alcohol_consumption%>%filter(Period>=2000)%>%group_by(Location)%>%miss_var_summary()%>%filter(n_miss>0)

# Handling missing data
Alcohol_consumption<-Alcohol_consumption%>%group_by(Location)%>%mutate(FactValueNumeric = imputeTS::na_interpolation(FactValueNumeric,maxgap=5))
Alcohol_consumption%>%filter(Period>=2000)%>%group_by(Location)%>%miss_var_summary()%>%filter(n_miss>0)
Alcohol_consumption<-Alcohol_consumption%>%filter(Period>=2000)%>%drop_na()
Alcohol_consumption%>%group_by(Location)%>%miss_var_summary()%>%filter(n_miss>0)

#Streamline
names(Alcohol_consumption)<-c("Year","Country","Code","ALC_Code")
```


```{r}
# Transforming and cleaning - Obesity - Habits
obesity<-read.csv("../Resources/Raw/Obesity_prevelance.csv",check.names=TRUE,header = TRUE, sep = ",", stringsAsFactors = FALSE)

# Remove unwanted fields 
obesity<-select(obesity,-c(which(grepl("\\.",names(obesity))))) #Columns for male and female contained "." since they were repeats
obesity<-tail(obesity,-3) # Removing first 3 rows after header

# Transform
obesity<-gather(obesity,key="Year",value="Obesity",X2016:X1975)

# Converting year to proper format
obesity$Year<-gsub("X","",obesity$Year)%>%as.numeric(as.character(obesity$Year))

# Converting obese people percentage to proper format
obesity$Obesity<-str_remove(obesity$Obesity,"\\[.*\\]")%>%as.numeric(obesity$Obesity)

# Extending the data
obesity<-obesity%>%complete(Year=seq(2017,2019),X)
obesity<-obesity%>%filter(Year>=2000)%>%group_by(X)%>%fill(Obesity,.direction ="up")

# Checking for missing data
obesity%>%group_by(X)%>%miss_var_summary()%>%filter(n_miss>0)

# Handling missing data
obesity<-drop_na(obesity)

# Streamline
names(obesity)<-c("Year","Country","OBP_Code")

```

### Immunization
```{r}
# Transforming and cleaning - BCG - Immunization
BCG<-read_excel("../Resources/Raw/BCG.xlsx")

# Remove unwanted data
BCG<-BCG%>%subset(COVERAGE_CATEGORY=="WUENIC"&nchar(CODE)>2&nchar(CODE)<8)%>%filter(YEAR<=2019)
BCG<-select(BCG,-c(GROUP,ANTIGEN,ANTIGEN_DESCRIPTION,COVERAGE_CATEGORY,COVERAGE_CATEGORY_DESCRIPTION,TARGET_NUMBER,DOSES))

#Formatting
BCG$CODE<-toupper(BCG$CODE)

# Checking missing data
BCG%>%group_by(YEAR)%>%count()
BCG%>%group_by(NAME)%>%miss_var_summary()%>%filter(n_miss>0)

# Extending dataset
BCG<-BCG%>%complete(YEAR=seq(2000,2019),NAME)%>%group_by(NAME)%>%fill(CODE,.direction ="downup")

# Checking missing data
BCG%>%group_by(YEAR)%>%count()
BCG%>%group_by(NAME)%>%miss_var_summary()%>%filter(n_miss>0)

# Fill up any missing data
BCG<-BCG%>%group_by(NAME)%>%fill(COVERAGE,.direction="down")
BCG%>%group_by(NAME)%>%miss_var_summary()%>%filter(n_miss>0)
BCG<-drop_na(BCG)
  
# Streamline
names(BCG)<-c("Year","Country","Code","BCG_Code")
```


```{r}
# Transforming and cleaning - Measles - Immunization
measles<-read_excel("../Resources/Raw/Measles vaccination coverage.xlsx")

# Remove unwanted data
measles<-measles%>%subset(COVERAGE_CATEGORY=="WUENIC"&nchar(CODE)>2&nchar(CODE)<8)%>%filter(YEAR<=2019)
measles<-select(measles,-c(GROUP,ANTIGEN,ANTIGEN_DESCRIPTION,COVERAGE_CATEGORY,COVERAGE_CATEGORY_DESCRIPTION,TARGET_NUMBER,DOSES))

#Formatting
measles$CODE<-toupper(measles$CODE)

# Checking missing data
measles%>%group_by(YEAR)%>%count()
measles%>%group_by(NAME)%>%miss_var_summary()%>%filter(n_miss>0)

# Extending dataset
measles<-measles%>%complete(YEAR=seq(2000,2019),NAME)%>%group_by(NAME)%>%fill(CODE,.direction ="downup")

# Checking missing data
measles%>%group_by(YEAR)%>%count()
measles%>%group_by(NAME)%>%miss_var_summary()%>%filter(n_miss>0)

# Handling missing data
measles<-drop_na(measles)

# Streamline
names(measles)<-c("Year","Country","Code","MCV_Code")

```


```{r}
# Transforming and cleaning - HepB - Immunization
hepatitis_set1<-read_excel("../Resources/Raw/Hepatitis B vaccination coverage.xlsx")
hepatitis_set2<-read.csv("../Resources/Raw/Life Expectancy Data.csv",check.names=TRUE,header = TRUE, sep = ",", stringsAsFactors = FALSE)

# Remove unwanted data
hepatitis_set1<-hepatitis_set1%>%subset(COVERAGE_CATEGORY=="WUENIC"&nchar(CODE)>2&nchar(CODE)<8)%>%filter(YEAR<=2019)
hepatitis_set1<-select(hepatitis_set1,-c(GROUP,ANTIGEN,ANTIGEN_DESCRIPTION,COVERAGE_CATEGORY,COVERAGE_CATEGORY_DESCRIPTION,TARGET_NUMBER,DOSES))
names(hepatitis_set1)<-c("Code","Country","Year","HEPB")

hepatitis_set2<-select(hepatitis_set2,c(Country,Year,Hepatitis.B))

# Checking missing data
hepatitis_set1%>%group_by(Year)%>%count()
# Fill in missing years
hepatitis_set1<-hepatitis_set1%>%complete(Year=seq(2000,2019),Country)

# Merge the two dataframes
hepatitis<-merge(hepatitis_set1,hepatitis_set2,by=c("Country","Year"),all=TRUE)

hepatitis$HEPB_Code<- ifelse(is.na(hepatitis$HEPB),hepatitis$Hepatitis.B,                 ifelse(is.na(hepatitis$Hepatitis.B),hepatitis$HEPB,                       ifelse(abs((hepatitis$HEPB-hepatitis$Hepatitis.B)/(hepatitis$HEPB+hepatitis$Hepatitis.B))/2<0.2,(hepatitis$HEPB+hepatitis$Hepatitis.B)/2,hepatitis$HEPB)))                         
hepatitis<-select(hepatitis,-c(HEPB,Hepatitis.B))                         

#Formatting
hepatitis$CODE<-toupper(hepatitis$CODE)

# Checking missing data
hepatitis%>%group_by(Country)%>%miss_var_summary()%>%filter(n_miss>0)

# Handling missing data

#Remove data with 80% missing data
hepatitis<-hepatitis%>%group_by(Country)%>%filter(!mean(is.na(HEPB_Code)) >= 0.2)
hepatitis%>%group_by(Country)%>%miss_var_summary()%>%filter(n_miss>0)
#Interpolate values to fill gaps
hepatitis<-hepatitis%>%group_by(Country)%>%mutate(HEPB_Code = imputeTS::na_interpolation(HEPB_Code))
#Fill in Code values for missing rows
hepatitis<-hepatitis%>%group_by(Country)%>%fill(Code,.direction ="downup")

hepatitis%>%group_by(Country)%>%miss_var_summary()%>%filter(n_miss>0)

# Dropped remaining missing values - Not listed in life expectancy
hepatitis<-drop_na(hepatitis)

```


```{r}
# Transforming and cleaning - DTT and DTP - Immunization
diptheria<-read_excel("../Resources/Raw/Diptheria.xlsx")

# Remove unwanted data
diptheria<-diptheria%>%subset(COVERAGE_CATEGORY=="WUENIC"&nchar(CODE)>2&nchar(CODE)<8)%>%filter(YEAR<=2019)
diptheria<-select(diptheria,-c(GROUP,ANTIGEN,ANTIGEN_DESCRIPTION,COVERAGE_CATEGORY,COVERAGE_CATEGORY_DESCRIPTION,TARGET_NUMBER,DOSES))

#Formatting
diptheria$CODE<-toupper(diptheria$CODE)

# Checking missing data
diptheria%>%group_by(YEAR)%>%count()
diptheria%>%group_by(NAME)%>%miss_var_summary()%>%filter(n_miss>0)

# Extending dataset
diptheria<-diptheria%>%complete(YEAR=seq(2000,2019),NAME)%>%group_by(NAME)%>%fill(CODE,.direction ="downup")

# Checking missing data
diptheria%>%group_by(YEAR)%>%count()
diptheria%>%group_by(NAME)%>%miss_var_summary()%>%filter(n_miss>0)

# Handling missing data
diptheria<-drop_na(diptheria)

# Streamline
names(diptheria)<-c("Year","Country","Code","DTP_Code")
```

### Economic
```{r}
# Transforming and cleaning - GDP - Economic
gdp<-read.csv("../Resources/Raw/GDP.csv",check.names=TRUE,header = TRUE, sep = ",", stringsAsFactors = FALSE, skip = 4)

# Remove unwanted fields
gdp<-select(gdp,-c(Indicator.Name,Indicator.Code,X))

# Transform
gdp<-gather(gdp,key="Year",value="GDP",X1960:X2020)

# Streamline
gdp$Year<-gsub("X","",gdp$Year)%>%as.numeric(as.character(gdp$Year))

# Checking for missing values
gdp<-subset(gdp,Year>=2000)
gdp%>%group_by(Country.Name)%>%miss_var_summary()%>%filter(n_miss>0)

# Handling missing values
gdp<-gdp%>%group_by(Country.Name)%>%filter(!mean(is.na(GDP)) >= 0.2)
gdp%>%group_by(Country.Name)%>%miss_var_summary()%>%filter(n_miss>0)

# Filling in missing values
gdp<-gdp%>%group_by(Country.Name)%>%mutate(GDP = imputeTS::na_interpolation(GDP))

# Final cleanup
gdp%>%group_by(Country.Name)%>%miss_var_summary()%>%filter(n_miss>0)
names(gdp)<-c("Country","Code","Year","GDP_Code")
```


```{r}
# Transforming and cleaning - GDP Growth - Economic
gdp_growth<-read.csv("../Resources/Raw/GDP_per_capita_growth.csv",check.names=TRUE,header = TRUE, sep = ",", stringsAsFactors = FALSE, skip = 4)

# Remove unwanted fields
gdp_growth<-select(gdp_growth,-c(Indicator.Name,Indicator.Code,X))

# Transform
gdp_growth<-gather(gdp_growth,key="Year",value="GDP_Growth",X1960:X2020)

# Streamline
gdp_growth$Year<-gsub("X","",gdp_growth$Year)%>%as.numeric(as.character(gdp_growth$Year))

# Checking for missing values
gdp_growth<-subset(gdp_growth,Year>=2000)
gdp_growth%>%group_by(Country.Name)%>%miss_var_summary()%>%filter(n_miss>0)

# Handling missing values
gdp_growth<-gdp_growth%>%group_by(Country.Name)%>%filter(!mean(is.na(GDP_Growth)) >= 0.2) 
gdp_growth%>%group_by(Country.Name)%>%miss_var_summary()%>%filter(n_miss>0)

# Filling in missing values
gdp_growth<-gdp_growth%>%group_by(Country.Name)%>%mutate(GDP_Growth = imputeTS::na_interpolation(GDP_Growth))

# Final cleanup
gdp_growth%>%group_by(Country.Name)%>%miss_var_summary()%>%filter(n_miss>0)
names(gdp_growth)<-c("Country","Code","Year","GDPG_Code")
```


```{r}
# Transforming and cleaning - Health Expenditure - Economic
he<-read.csv("../Resources/Raw/Health Expenditure.csv",check.names=TRUE,header = TRUE, sep = ",", stringsAsFactors = FALSE)

# Remove unwanted fields 
he<-select(he,-c(Indicators,X))
he<-tail(he,-1) # Removing first after header

# Transform
he<-gather(he,key="Year",value="HE_Code",X2000:X2019)

# Converting to proper format
he$Year<-gsub("X","",he$Year)%>%as.numeric(as.character(he$Year))
he$HE_Code<-as.numeric(he$HE_Code)

# Checking for missing data
he%>%group_by(Countries)%>%miss_var_summary()%>%filter(n_miss>0)

# Handling missing data
he<-he%>%group_by(Countries)%>%filter(!mean(is.na(HE_Code)) >= 0.2)
he%>%group_by(Countries)%>%miss_var_summary()%>%filter(n_miss>0)
he<-he%>%group_by(Countries)%>%mutate(HE_Code = imputeTS::na_interpolation(HE_Code))

# Streamline
names(he)<-c("Country","Year","HE_Code")
```

### Socio-Economic
```{r}
# Transforming and cleaning - SexRatio - Socio-Economic
sr<-read.csv("../Resources/Raw/SexRatio.csv",check.names=TRUE,header = TRUE, sep = ",", stringsAsFactors = FALSE,skip=1)

# Remove unwanted fields 
sr<-select(sr,-c(ISO.3166.1.numeric.code,Note))
sr<-tail(sr,-2) 

# Transform
sr<-gather(sr,key="Year",value="SR_Code",X1950:X2020)
sr<-subset(sr,Year>=2000)

# Converting to proper format
sr$Year<-gsub("X","",sr$Year)%>%as.numeric(as.character(sr$Year))
sr$Location<-trimws(sr$Location)

# Checking for missing data
sr%>%group_by(Location)%>%miss_var_summary()%>%filter(n_miss>0)

# Handling missing data
sr<-sr%>%group_by(Location)%>%filter(!mean(is.na(SR_Code)) == 1)
sr%>%group_by(Location)%>%miss_var_summary()%>%filter(n_miss>0)

# Extending data
sr<-sr%>%complete(Year=seq(min(Year),max(Year)),Location)%>%group_by(Location)%>%fill(SR_Code,.direction="down")

# Streamline
names(sr)<-c("Country","Year","SR_Code")
```

### Health
```{r}
# Transforming and cleaning - Cancer - Health
cancer<-read.csv("../Resources/Raw/Cancer.csv",check.names=TRUE,header = TRUE, sep = ",", stringsAsFactors = FALSE)

# Streamline
names(cancer)<-c("Country","Code","Year","CANP_Code")

# Subsetting data
cancer<-subset(cancer,Year>=2000)

# Handling missing values
cancer%>%group_by(Country)%>%miss_var_summary()%>%filter(n_miss>0)
cancer%>%group_by(Year)%>%count()
cancer<-cancer%>%complete(Year=seq(2000,2019),Country)%>%group_by(Country)%>%fill(c(Code,CANP_Code),.direction="down") #Extending to 2019
cancer%>%group_by(Year)%>%count()

```


```{r}
# Transforming and cleaning - Diabetes - Health
diabetes<-read.csv("../Resources/Raw/Diabetes.csv",check.names=TRUE,header = TRUE, sep = ",", stringsAsFactors = FALSE)

# Streamline
diabetes<-select(diabetes,-c(Lower.95..uncertainty.interval,  
Upper.95..uncertainty.interval))
names(diabetes)<-c("Country","Code","Sex","Year","DB_Code")

# Transform
diabetes<-spread(diabetes,key="Sex",value="DB_Code")

# Average
diabetes$DB_Code<-(diabetes$Men+diabetes$Women)/2

# Removing unwanted data
diabetes<-diabetes%>%subset(Year>=2000)%>%select(-c(Men,Women))

# Handling missing values
diabetes%>%group_by(Country)%>%miss_var_summary()%>%filter(n_miss>0)
diabetes%>%group_by(Year)%>%count()

```

